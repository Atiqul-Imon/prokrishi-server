name: Deploy to Production - Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    name: Deploy to Digital Ocean
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DROPLET_SSH_PRIVATE_KEY }}

    - name: Add Droplet to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

    - name: Deploy to Digital Ocean Droplet
      env:
        DROPLET_USER: ${{ secrets.DROPLET_USER }}
        DROPLET_IP: ${{ secrets.DROPLET_IP }}
        DROPLET_PATH: ${{ secrets.DROPLET_PATH }}
      run: |
        echo "üöÄ Starting deployment to Digital Ocean..."
        echo "üìç Deployment path: $DROPLET_PATH"
        echo "üìç Droplet IP: $DROPLET_IP"
        echo "üìç Droplet User: $DROPLET_USER"
        
        # Create deployment script with proper variable substitution
        cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
        #!/bin/bash
        set -e
        
        DEPLOY_PATH="$1"
        REPO_URL="$2"
        echo "üìç Deployment path: $DEPLOY_PATH"
        echo "üìç Repository URL: $REPO_URL"
        
        # Check if directory exists
        if [ ! -d "$DEPLOY_PATH" ]; then
          echo "‚ùå Error: Directory $DEPLOY_PATH does not exist!"
          exit 1
        fi
        
        cd "$DEPLOY_PATH"
        
        # Check if it's a git repository
        if [ ! -d ".git" ]; then
          echo "‚ùå Error: $DEPLOY_PATH is not a git repository!"
          echo "üìã Contents of $DEPLOY_PATH:"
          ls -la || true
          exit 1
        fi
        
        # Pull latest changes
        echo "üì¶ Pulling latest changes from GitHub..."
        git fetch origin || { echo "‚ö†Ô∏è  Git fetch failed, continuing..."; }
        git reset --hard origin/main || { echo "‚ùå Git reset failed!"; exit 1; }
        
        echo "üì¶ Installing/updating dependencies..."
        npm ci --production || { echo "‚ùå npm install failed!"; exit 1; }
        
        echo "üîÑ Restarting application with PM2..."
        if pm2 list | grep -q "prokrishi-backend"; then
          pm2 restart prokrishi-backend
        else
          if [ -f "ecosystem.config.cjs" ]; then
            pm2 start ecosystem.config.cjs --env production
          elif [ -f "ecosystem.config.js" ]; then
            pm2 start ecosystem.config.js --env production
          else
            echo "‚ö†Ô∏è  ecosystem.config not found, trying to start with npm..."
            pm2 start npm --name "prokrishi-backend" -- start
          fi
        fi
        
        echo "üíæ Saving PM2 process list..."
        pm2 save || echo "‚ö†Ô∏è  PM2 save failed (may not be critical)"
        
        echo "‚úÖ Deployment completed successfully!"
        
        # Show status
        pm2 status
        DEPLOY_SCRIPT
        
        # Copy deployment script to droplet
        scp /tmp/deploy.sh ${DROPLET_USER}@${DROPLET_IP}:/tmp/deploy.sh
        
        # Execute deployment on droplet with path and repo URL as arguments
        REPO_URL="https://github.com/Atiqul-Imon/prokrishi-server.git"
        ssh ${DROPLET_USER}@${DROPLET_IP} "chmod +x /tmp/deploy.sh && /tmp/deploy.sh '$DROPLET_PATH' '$REPO_URL'"

    - name: Verify deployment
      env:
        DROPLET_USER: ${{ secrets.DROPLET_USER }}
        DROPLET_IP: ${{ secrets.DROPLET_IP }}
        BACKEND_URL: ${{ secrets.BACKEND_URL }}
      run: |
        echo "üîç Verifying deployment..."
        
        # Wait a few seconds for application to start
        sleep 5
        
        # Check health endpoint
        if curl -f -s ${BACKEND_URL}/health > /dev/null; then
          echo "‚úÖ Health check passed!"
        else
          echo "‚ö†Ô∏è  Health check failed, but deployment may still be in progress"
          # Don't fail the workflow, just warn
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment successful!"
        else
          echo "‚ùå Deployment failed!"
        fi

